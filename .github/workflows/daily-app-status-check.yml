name: Daily App Status Check

on:
  # Schedule to run every day at 3:00 PM IST (9:30 AM UTC)
  schedule:
    - cron: '30 9 * * *'  # 3:00 PM IST = 9:30 AM UTC
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  test-app-availability:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run unified app verification tests
        run: npx playwright test unified.spec.ts --reporter=list
        continue-on-error: true
      
      - name: Generate HTML report
        if: always()
        run: |
          npx tsc generate-report.ts --esModuleInterop --resolveJsonModule
          node generate-report.js
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            test-results/
            custom-reports/
          retention-days: 30
      
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: html-report-${{ github.run_number }}
          path: custom-reports/Unified_App_Verification_Report.html
          retention-days: 30
      
      - name: Deploy report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./custom-reports
          destination_dir: reports/${{ github.run_number }}
          keep_files: true
      
      - name: Comment on commit with report link
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const runNumber = context.runNumber;
            const repoUrl = context.payload.repository.html_url;
            const reportUrl = `${repoUrl.replace('github.com', 'github.io').replace('https://', 'https://').split('/').slice(0, 4).join('/')}/reports/${runNumber}/Unified_App_Verification_Report.html`;

            console.log(`Report available at: ${reportUrl}`);

            // Create a summary
            core.summary
              .addHeading('ðŸ“Š App Status Report Generated')
              .addRaw(`Report #${runNumber} has been generated successfully!`)
              .addLink('View Report', reportUrl)
              .write();

      - name: Read test results for email
        if: always()
        id: read_results
        run: |
          # Count test results
          TOTAL_TESTS=9
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT

          # Get current date
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M:%S')
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT

      - name: Create email notification issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runNumber = context.runNumber;
            const runId = context.runId;
            const repoUrl = context.payload.repository.html_url;
            const artifactUrl = `${repoUrl}/actions/runs/${runId}`;

            // Read the HTML report
            let reportContent = '';
            try {
              reportContent = fs.readFileSync('custom-reports/Unified_App_Verification_Report.html', 'utf8');
            } catch (error) {
              reportContent = 'Report file not found';
            }

            // Create issue with report
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“Š App Status Report #${runNumber} - ${new Date().toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' })}`,
              body: `## ðŸ“Š Adhash Application Status Report

            **Report Number:** #${runNumber}
            **Date:** ${new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}
            **Workflow Run:** [View Details](${artifactUrl})

            ### ðŸ“± Apps Verified:
            - âœ… AutoChecker (Play Store)
            - âœ… WavedIn (Play Store & App Store)
            - âœ… Algomax (Play Store & App Store)
            - âœ… Auto eVantage (Play Store & App Store)
            - âœ… Spark me (Play Store & App Store)

            ### ðŸ“¥ Download Report:
            - [Download HTML Report Artifact](${artifactUrl})
            - The full HTML report with all logos is available in the workflow artifacts

            ### ðŸ”— Quick Links:
            - [View Workflow Run](${artifactUrl})
            - [Download Artifacts](${artifactUrl}#artifacts)

            ---

            <details>
            <summary>ðŸ“„ Click to view full HTML report</summary>

            \`\`\`html
            ${reportContent.substring(0, 60000)}
            \`\`\`

            </details>

            ---

            **Note:** Subscribe to this repository to receive email notifications for new reports.
            Click "Watch" â†’ "Custom" â†’ "Issues" to get notified via email when new reports are created.

            *This is an automated report generated daily at 3:00 PM IST*`,
              labels: ['automated-report', 'app-status']
            });

            console.log(`Issue created: ${issue.data.html_url}`);

            // Add comment with download instructions
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `### ðŸ“§ Email Notification Setup

            To receive this report via email automatically:

            1. Click the **Watch** button at the top of this repository
            2. Select **Custom**
            3. Check **Issues**
            4. Click **Apply**

            You will now receive an email from GitHub whenever a new report is created!

            The email will include:
            - âœ… Report summary
            - âœ… Links to download the full HTML report
            - âœ… Direct link to view this issue

            **Download the HTML report:**
            - Go to [Workflow Run](${artifactUrl})
            - Scroll to "Artifacts" section
            - Download "html-report-${runNumber}"
            - Open the HTML file in your browser`
            });

      - name: Close old report issues
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // Close issues older than 30 days
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'automated-report',
              state: 'open'
            });

            for (const issue of issues.data) {
              const createdAt = new Date(issue.created_at);
              if (createdAt < thirtyDaysAgo) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                console.log(`Closed old issue #${issue.number}`);
              }
            }

